<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤–è´¸åˆåŒæ™ºèƒ½å®¡æ ¸åŠ©æ‰‹</title>
    <!-- ç§»é™¤åŸæœ‰çš„å…¨éƒ¨æ ·å¼ï¼Œåªä¿ç•™å…³é”®éƒ¨åˆ†ï¼ŒèŠ‚çœç¯‡å¹… -->
    <style>
        /* ä¿æŒåŸæœ‰çš„æ‰€æœ‰æ ·å¼ä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white;
                    border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                    overflow: hidden; display: flex; flex-direction: column; min-height: 90vh; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
                  color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        /* ... å…¶ä»–æ ·å¼ä¿æŒä¸å˜ ... */
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- ä¿æŒåŸæœ‰HTMLç»“æ„ä¸å˜ -->
        <div class="header">
            <h1>å¤–è´¸åˆåŒæ™ºèƒ½å®¡æ ¸åŠ©æ‰‹</h1>
            <p>AI-Powered Foreign Trade Contract Review Assistant</p>
        </div>
        
        <div class="main-content">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="file-info" v-if="file">
                    <h3>æ–‡ä»¶ä¿¡æ¯</h3>
                    <ul class="file-details">
                        <li><span class="label">æ–‡ä»¶å</span><span class="value">{{ file.name }}</span></li>
                        <li><span class="label">æ–‡ä»¶å¤§å°</span><span class="value">{{ formatFileSize(file.size) }}</span></li>
                        <li><span class="label">ç±»å‹</span><span class="value">{{ getFileType(file.name) }}</span></li>
                        <li><span class="label">åˆ†æè¯­è¨€</span><span class="value">{{ languageText }}</span></li>
                        <li v-if="aiResult"><span class="label">åˆ†ææ—¶é—´</span><span class="value">{{ currentTime }}</span></li>
                    </ul>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn" @click="downloadReport" v-if="aiResult">ğŸ“¥ ä¸‹è½½æŠ¥å‘Š</button>
                    <button class="action-btn" @click="newAnalysis">ğŸ”„ æ–°åˆ†æ</button>
                    <button class="action-btn primary" @click="showHelp">â“ ä½¿ç”¨å¸®åŠ©</button>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-section">
                    <h2>ä¸Šä¼ åˆåŒæ–‡ä»¶</h2>
                    <p style="margin-bottom: 20px; color: #6c757d;">æ”¯æŒ PDF å’Œ Word æ ¼å¼æ–‡ä»¶</p>
                    
                    <div class="upload-container">
                        <div class="file-input-container">
                            <input type="file" id="fileInput" class="file-input" @change="handleFileUpload" accept=".pdf,.docx,.txt">
                            <select v-model="language" class="language-select">
                                <option value="zh">ä¸­æ–‡åˆåŒ</option>
                                <option value="en">English Contract</option>
                                <option value="es">EspaÃ±ol Contrato</option>
                            </select>
                        </div>
                        
                        <button @click="analyzeContract" :disabled="!file || analyzing" class="analyze-btn">
                            {{ analyzing ? 'åˆ†æä¸­...' : 'å¼€å§‹æ™ºèƒ½åˆ†æ' }}
                        </button>
                    </div>
                    
                    <div v-if="file" class="file-status">
                        <strong>å·²é€‰æ‹©æ–‡ä»¶:</strong> {{ file.name }}
                    </div>
                </div>
                
                <!-- ç»“æœåŒºåŸŸ -->
                <div class="result-section">
                    <h2>åˆ†æç»“æœ</h2>
                    
                    <div v-if="analyzing" class="loading">
                        <div class="spinner"></div>
                        <p>AIæ­£åœ¨æ·±åº¦åˆ†æåˆåŒå†…å®¹ï¼Œè¯·ç¨å€™...</p>
                        <p v-if="progress > 0" style="margin-top: 10px;">åˆ†æè¿›åº¦: {{ progress }}%</p>
                    </div>
                    
                    <div v-else-if="aiResult">
                        <div class="summary">
                            <h3>ğŸ“Š åˆ†ææŠ¥å‘Šæ‘˜è¦</h3>
                            <p>AI å·²å®ŒæˆåˆåŒæ·±åº¦åˆ†æï¼Œå‘ç°å…³é”®é£é™©ç‚¹å¹¶æä¾›ä¸“ä¸šå»ºè®®</p>
                            <div class="analysis-meta">
                                <span>ğŸ“… åˆ†ææ—¶é—´: {{ currentTime }}</span>
                                <span>ğŸ“„ æ–‡ä»¶: {{ file.name }}</span>
                                <span>ğŸŒ è¯­è¨€: {{ languageText }}</span>
                            </div>
                        </div>
                        
                        <div class="ai-result" v-html="formatAiResult(aiResult)"></div>
                    </div>
                    
                    <div v-else class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <h3>å‡†å¤‡åˆ†æ</h3>
                        <p>ä¸Šä¼ åˆåŒæ–‡ä»¶å¼€å§‹åˆ†æ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.5.0/dist/axios.min.js"></script>
    <script>
        // ä»£ç†æœåŠ¡å™¨åœ°å€ - ä¿®æ”¹ä¸ºæ‚¨éƒ¨ç½²çš„åœ°å€
        const PROXY_SERVER = '/api/analyze'; // æˆ– 'http://localhost:3000'
        
        new Vue({
            el: '#app',
            data: {
                file: null,
                language: 'zh',
                analyzing: false,
                aiResult: null,
                currentTime: new Date().toLocaleString('zh-CN'),
                progress: 0
            },
            computed: {
                languageText() {
                    const languages = { 'zh': 'ä¸­æ–‡', 'en': 'English', 'es': 'EspaÃ±ol' };
                    return languages[this.language] || this.language;
                }
            },
            methods: {
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                getFileType(filename) {
                    const ext = filename.split('.').pop().toLowerCase();
                    return ext === 'pdf' ? 'PDF æ–‡æ¡£' : 
                           ext === 'docx' ? 'Word æ–‡æ¡£' : 
                           'æ–‡æœ¬æ–‡ä»¶';
                },
                
                async readFileContent(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        
                        if (file.name.toLowerCase().endsWith('.txt') || 
                            file.name.toLowerCase().endsWith('.pdf') || 
                            file.name.toLowerCase().endsWith('.docx')) {
                            // å¯¹äºè¿™äº›æ–‡ä»¶ï¼Œç›´æ¥è¯»å–ä¸ºæ–‡æœ¬
                            reader.onload = (e) => {
                                // å¦‚æœæ˜¯PDF/DOCXï¼Œè¿™é‡Œåªæ˜¯ç®€å•è¯»å–ï¼Œå®é™…åº”è¯¥è§£æ
                                if (file.name.toLowerCase().endsWith('.pdf')) {
                                    resolve(`[PDFæ–‡ä»¶] ${file.name}\n\nç”±äºæµè§ˆå™¨é™åˆ¶ï¼ŒPDFæ–‡ä»¶éœ€è¦ä¸“ç”¨è§£æå™¨ã€‚\nå»ºè®®ä½¿ç”¨æ–‡æœ¬æ ¼å¼çš„åˆåŒæ–‡ä»¶ã€‚`);
                                } else if (file.name.toLowerCase().endsWith('.docx')) {
                                    resolve(`[Wordæ–‡ä»¶] ${file.name}\n\nç”±äºæµè§ˆå™¨é™åˆ¶ï¼ŒWordæ–‡ä»¶éœ€è¦ä¸“ç”¨è§£æå™¨ã€‚\nå»ºè®®ä½¿ç”¨æ–‡æœ¬æ ¼å¼çš„åˆåŒæ–‡ä»¶ã€‚`);
                                } else {
                                    resolve(e.target.result);
                                }
                            };
                            reader.readAsText(file);
                        } else {
                            reject(new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼'));
                        }
                        
                        reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    });
                },
                
                handleFileUpload(event) {
                    this.file = event.target.files[0];
                    this.aiResult = null;
                    this.currentTime = new Date().toLocaleString('zh-CN');
                },
                
                async analyzeContract() {
                    if (!this.file) {
                        alert('è¯·å…ˆé€‰æ‹©åˆåŒæ–‡ä»¶');
                        return;
                    }
                    
                    this.analyzing = true;
                    this.progress = 0;
                    this.aiResult = null;
                    this.currentTime = new Date().toLocaleString('zh-CN');
                    
                    const progressInterval = setInterval(() => {
                        if (this.progress < 90) this.progress += 10;
                    }, 1000);
                    
                    try {
                        // 1. è¯»å–æ–‡ä»¶å†…å®¹
                        this.progress = 10;
                        const fileContent = await this.readFileContent(this.file);
                        
                        // 2. é€šè¿‡ä»£ç†æœåŠ¡å™¨è°ƒç”¨AI API
                        this.progress = 30;
                        const response = await axios.post(PROXY_SERVER, {
                        text: fileContent.substring(0, 3000),
                        lang: this.language
                        }, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        timeout: 60000
                        });
                        
                        // 3. å¤„ç†ç»“æœ
                        this.progress = 90;
                        if (response.data.result) {
                            this.aiResult = response.data.result;
                        } else {
                            throw new Error('æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                        
                        clearInterval(progressInterval);
                        this.progress = 100;
                        
                        setTimeout(() => {
                            this.analyzing = false;
                            this.progress = 0;
                        }, 500);
                        
                    } catch (error) {
                        console.error('åˆ†æå¤±è´¥:', error);
                        clearInterval(progressInterval);
                        this.analyzing = false;
                        this.progress = 0;
                        
                        let errorMsg = 'åˆ†æå¤±è´¥ï¼š';
                        if (error.code === 'ECONNABORTED') {
                            errorMsg += 'è¯·æ±‚è¶…æ—¶';
                        } else if (error.response) {
                            errorMsg += `æœåŠ¡å™¨é”™è¯¯ (${error.response.status})`;
                        } else if (error.request) {
                            errorMsg += 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä»£ç†æœåŠ¡å™¨åœ°å€';
                        } else {
                            errorMsg += error.message;
                        }
                        
                        alert(errorMsg);
                    }
                },
                
                formatAiResult(text) {
                    if (!text) return '<div class="empty-state"><p>æš‚æ— åˆ†æç»“æœ</p></div>';
                    
                    // ç®€å•æ ¼å¼åŒ–æ–‡æœ¬
                    const paragraphs = text.split('\n').filter(p => p.trim());
                    let html = '';
                    
                    paragraphs.forEach(para => {
                        const trimmed = para.trim();
                        if (trimmed.includes('é£é™©ç‚¹') || trimmed.includes('é£é™©ï¼š') || 
                            trimmed.match(/^\d+\./) || trimmed.includes('å»ºè®®ï¼š')) {
                            html += `<div class="risk-card"><div class="risk-content">${trimmed}</div></div>`;
                        } else if (trimmed.length > 10) {
                            html += `<p style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${trimmed}</p>`;
                        }
                    });
                    
                    return html || `<div class="risk-card"><div class="risk-content">${text}</div></div>`;
                },
                
                downloadReport() {
                    if (!this.aiResult) {
                        alert('æ²¡æœ‰åˆ†æç»“æœå¯ä¸‹è½½');
                        return;
                    }
                    
                    const content = `åˆåŒåˆ†ææŠ¥å‘Š\næ–‡ä»¶ï¼š${this.file.name}\næ—¶é—´ï¼š${this.currentTime}\n\n${this.aiResult}`;
                    const blob = new Blob([content], { type: 'text/plain' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `åˆåŒåˆ†æ_${this.file.name}.txt`;
                    link.click();
                },
                
                newAnalysis() {
                    this.file = null;
                    this.aiResult = null;
                    document.getElementById('fileInput').value = '';
                },
                
                showHelp() {
                    alert('ä½¿ç”¨å¸®åŠ©ï¼š\n1. ä¸Šä¼ æ–‡æœ¬ã€PDFæˆ–Wordæ ¼å¼çš„åˆåŒ\n2. é€‰æ‹©åˆ†æè¯­è¨€\n3. ç‚¹å‡»å¼€å§‹åˆ†æ\n\næ³¨æ„ï¼šPDF/Wordæ–‡ä»¶çš„å®Œæ•´è§£æéœ€è¦ä¸“ç”¨è§£æå™¨ã€‚');
                }
            }
        });
    </script>
</body>
</html>